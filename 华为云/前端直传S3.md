# 前端直传S3调研

s3链接：

[s3链接]: https://support.huaweicloud.com/sdk-browserjs-devg-obs/obs_24_0001.html

## 调研(SDK)
#### 鉴权

##### 前端鉴权（SDK）

- 前端存AK，SK

##### 后端鉴权

- 后端返回AK，SK，前端初始化(SDK)

- Header中携带权鉴（API）

  - (需要一次返回多个接口(分段、初始化、合并等)的鉴权

  - 前端需要写多个接口请求上传分件

    

#### 创建文件夹(SDK调用)

- 直接创建

  ```javascript
  obsClient.putObject({
         Bucket: 'bucketname', // 桶名
         Key: 'parent_directory/' // 文件夹，必须以‘/’ 结尾
  }, function (err, result) {
         if(err){
                console.error('Error-->' + err);
         }else{
                console.log('Status-->' + result.CommonMsg.Status);
         }
  });
  ```

  

- 间接创建(会主动创建hx目录)

  ```js
  obsClient.putObject({
         Bucket: 'bucketname', 
         Key: 'objectname', // 文件路径 + 文件名，即：hx/xxx.xxx
         SourceFile: document.getElementById('input-file').files[0] // 文件
  }, function (err, result) {
         if(err){
                console.error('Error-->' + err);
         }else{
                console.log('Status-->' + result.CommonMsg.Status);
         }
  });
  ```



#### 删除文件

- 删除文件

  ```js
  obsClient.deleteObject({
         Bucket: 'bucketname',
         Key : 'objectname'
  }, function (err, result) {
         if(err){
                console.log('Error-->' + err);
         }else{
                console.log('Status-->' + result.CommonMsg.Status);
         }
  });
  ```

- 批量删除

  ```js
  obsClient.deleteObjects({ 
         Bucket: 'bucketname', 
         // 设置为verbose模式 
         Quiet : false, 
         Objects : [{Key:'objectname1'},{Key:'objectname2'}, {Key : 'objectname3'}]  // 删除的文件路径
  }, function (err, result) { 
         if(err){ 
                console.log('Error-->' + err); 
         }else{ 
                console.log('Status-->' + result.CommonMsg.Status); 
                if(result.CommonMsg.Status < 300 && result.InterfaceResult){
                  // 获取删除成功的对象 
                  console.log('Deleteds:'); 
                  for(var i in result.InterfaceResult.Deleteds){ 
                         console.log('Deleted[' + i + ']:'); 
                         console.log('Key-->'+result.InterfaceResult.Deleteds[i]['Key']); 
                         console.log('VersionId-->' + result.InterfaceResult.Deleteds[i]['VersionId']); 
                  } 
                  // 获取删除失败的对象 
                  console.log('Errors:'); 
                  for(var i in result.InterfaceResult.Errors){ 
                         console.log('Error[' + i + ']:'); 
                         console.log('Key-->' + result.InterfaceResult.Errors[i]['Key']); 
                         console.log('VersionId-->' + result.InterfaceResult.Errors[i]['VersionId']); 
                  } 
                }
         } 
  });
  ```

- 删除文件夹(需要批量删除当前文件夹下的所有文件=>即删除当前文件夹)

  ```js
  obsClient.deleteObjects({ 
         Bucket: 'bucketname', 
         // 设置为verbose模式 
         Quiet : false, 
         Objects : [{Key:'objectname1'},{Key:'objectname2'}, {Key : 'objectname3'}] 
  }, function (err, result) { 
         if(err){ 
                console.log('Error-->' + err); 
         }else{ 
                console.log('Status-->' + result.CommonMsg.Status); 
                if(result.CommonMsg.Status < 300 && result.InterfaceResult){
                  // 获取删除成功的对象 
                  console.log('Deleteds:'); 
                  for(var i in result.InterfaceResult.Deleteds){ 
                         console.log('Deleted[' + i + ']:'); 
                         console.log('Key-->'+result.InterfaceResult.Deleteds[i]['Key']); 
                         console.log('VersionId-->' + result.InterfaceResult.Deleteds[i]['VersionId']); 
                  } 
                  // 获取删除失败的对象 
                  console.log('Errors:'); 
                  for(var i in result.InterfaceResult.Errors){ 
                         console.log('Error[' + i + ']:'); 
                         console.log('Key-->' + result.InterfaceResult.Errors[i]['Key']); 
                         console.log('VersionId-->' + result.InterfaceResult.Errors[i]['VersionId']); 
                  } 
                }
         } 
  });
  ```



#### 上传文件

##### 单文件上传

```js
obsClient.putObject({
       Bucket: 'bucketname',
       Key: 'objectname',
       SourceFile: document.getElementById('input-file').files[0]
}, function (err, result) {
       if(err){
              console.error('Error-->' + err);
       }else{
              console.log('Status-->' + result.CommonMsg.Status);
       }
});
```



##### 文件分段上传(需要考虑各种异常处理、重试、并发机制)

- 初始化文件分段

  ```js
  obsClient.initiateMultipartUpload({
         Bucket : 'bucketname',
         Key : 'objectname', // 某个文件的具体路径
  }, function (err, result) {
         if(err){
                console.error('Error-->' + err);
         }else{
                console.log('Status-->' + result.CommonMsg.Status);
                if(result.CommonMsg.Status < 300 && result.InterfaceResult){
                       console.log('UploadId-->' + result.InterfaceResult.UploadId);
                }
         }
  });
  ```

- 分段上传

  ```js
  obsClient.uploadPart({
          Bucket: bucketname,
          Key: objectname,
          // 设置分段号，范围是1~10000
          PartNumber: n,
          // 设置Upload ID
          UploadId,
          // 设置将要上传的大文件
          SourceFile: file,
          // 设置分段大小
          PartSize: count === n ? lastPartSize : PartSize,
          // 设置分段的起始偏移大小
          Offset: (n-1) * PartSize
      }, function (err, result) {
          if(err){
                  console.log('Error-->' + err);
          }else{
                  console.log('Status-->' + result.CommonMsg.Status);
                  if(result.CommonMsg.Status < 300 && result.InterfaceResult){
                        console.log('ETag-->' + result.InterfaceResult.ETag);
                  }
          }
      });
  ```

- 合并分段

  ```js
  obsClient.completeMultipartUpload({
         Bucket:'bucketname',
         Key:'objectname',
         // 设置Upload ID
         UploadId:'upload id from initiateMultipartUpload',
         Parts: [{'PartNumber':1,'ETag':'etag value from uploadPart'}]
  }, function (err, result) {
         if(err){
                console.log('Error-->' + err);
         }else{
                console.log('Status-->' + result.CommonMsg.Status);
         }
  });
  ```



##### 断点续传(已将上面的三个功能合并，并有重试、并发机制)

```js
var cp;
var hook;
obsClient.uploadFile({
       Bucket : 'bucketname',
       Key : 'objectname',
       SourceFile : document.getElementById('input-file').files[0],
       PartSize : 9 * 1024 * 1024,
       ProgressCallback : function(transferredAmount, totalAmount, totalSeconds){
           console.log(transferredAmount * 1.0 / totalSeconds / 1024);
           console.log(transferredAmount * 100.0 / totalAmount);
           if(hook && (transferredAmount / totalAmount) > 0.5){
               // 暂停断点续传任务
               hook.cancel();
           }
       },
       EventCallback : function(eventType, eventParam, eventResult){
           // 处理事件响应
       },
       ResumeCallback : function(resumeHook, uploadCheckpoint){
           // 获取取消断点续传上传任务控制参数
           hook = resumeHook;
           // 记录断点
           cp = uploadCheckpoint;
       }
}, function(err, result){
    console.error('Error-->' + err);
    // 出现错误，再次调用断点续传接口，继续上传任务
    if(err){
       obsClient.uploadFile({
          UploadCheckpoint : cp,
          ProgressCallback : function(transferredAmount, totalAmount, totalSeconds){
              console.log(transferredAmount * 1.0 / totalSeconds / 1024);
              console.log(transferredAmount * 100.0 / totalAmount);
          },
          EventCallback : function(eventType, eventParam, eventResult){
             // 处理事件响应
          },
        }, function(err, result){
          if(err){
              console.error('Error-->' + err);
          }else{
              if(result.CommonMsg.Status < 300){
                 console.log('RequestId-->' + result.InterfaceResult.RequestId);
                 console.log('Bucket-->' + result.InterfaceResult.Bucket);
                 console.log('Key-->' + result.InterfaceResult.Key);
                 console.log('Location-->' + result.InterfaceResult.Location);
              }else{
                 console.log('Code-->' + result.CommonMsg.Code);
                 console.log('Message-->' + result.CommonMsg.Message);
              }
        }
      });
    }else {
         console.log('Status-->' + result.CommonMsg.Status);
         if (result.CommonMsg.Status < 300 && result.InterfaceResult) {
                console.log('RequestId-->' + result.InterfaceResult.RequestId);
         }
    }
});
```



#### 重命名对象

##### 重命名文件

复制当前对象，并删除原有的对象(暂时需要调研)



##### 重命名文件夹

(暂时需要调研)

```js
obsClient.copyObject({
       Bucket: 'destbucketname',
       Key : 'destobjectname',
       CopySource:'sourcebucketname/sourceobjectname'
}, function (err, result) {
       if(err){
              console.log('Error-->' + err);
       }else{
              console.log('Status-->' + result.CommonMsg.Status);
       }
});
```



## 调研（API）

暂时没有调研

